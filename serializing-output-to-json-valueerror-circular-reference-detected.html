<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=description content="I'm trying to output results of my mysql query to JSON. I have problem with serializing datetime.datetime field, so I wrote small function to do that: and then in main code I'm just running: However, since I wrote date_handler function, I'm getting &amp;quot;ValueError: Circular reference detected&amp;quot;"><meta name=author content="Larita Shotwell"><meta name=generator content="Hugo 0.98.0"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=robots content="index,follow,noarchive"><link rel=stylesheet href=https://assets.cdnweb.info/hugo/base16/css/style.css type=text/css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type=text/css><link rel=alternate href=./index.xml type=application/rss+xml title=SyncX><title>Serializing output to JSON - ValueError: Circular reference detected - SyncX</title></head><body><header><div class="container clearfix"><a class=path href=./index.html>[SyncX]</a>
<span class=caret># _</span><div class=right></div></div></header><div class=container><main role=main class=article><article class=single itemscope itemtype=http://schema.org/BlogPosting><div class=meta><span class=key>published on</span>
<span class=val><time itemprop=datePublished datetime=2024-08-08>August 08, 2024</time></span>
<span class=key>in</span>
<span class=val><a href=./categories/blog>blog</a></span></div><h1 class=headline itemprop=headline>Serializing output to JSON - ValueError: Circular reference detected</h1><section class=body itemprop=articleBody><img src=https://cdn.statically.io/img/cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png style=margin:auto;display:block;text-align:center;max-width:100%;height:auto><p>I'm trying to output results of my mysql query to JSON. I have problem with serializing datetime.datetime field, so I wrote small function to do that:</p><pre><code>def date_handler(obj): if hasattr(obj, 'isoformat'): return obj.isoformat() else: return obj </code></pre><p>and then in main code I'm just running:</p><pre><code>products_json = [] for code in best_matching_codes: cur = db.cursor() query = "SELECT * FROM %s WHERE code LIKE '%s'" % (PRODUCTS_TABLE_NAME, product_code) cur.execute(query) columns = [desc[0] for desc in cur.description] rows = cur.fetchall() for row in rows: products_json.append(dict((k,v) for k,v in zip(columns,row))) return json.dumps(products_json, default = date_handler) </code></pre><p>However, since I wrote date_handler function, I'm getting "ValueError: Circular reference detected"</p><pre><code>127.0.0.1 - - [10/Jan/2013 00:42:18] "GET /1/product?code=9571%2F702 HTTP/1.1" 500 - Traceback (most recent call last): File "/Library/Python/2.7/site-packages/flask/app.py", line 1701, in __call__ return self.wsgi_app(environ, start_response) File "/Library/Python/2.7/site-packages/flask/app.py", line 1689, in wsgi_app response = self.make_response(self.handle_exception(e)) File "/Library/Python/2.7/site-packages/flask/app.py", line 1687, in wsgi_app response = self.full_dispatch_request() File "/Library/Python/2.7/site-packages/flask/app.py", line 1360, in full_dispatch_request rv = self.handle_user_exception(e) File "/Library/Python/2.7/site-packages/flask/app.py", line 1358, in full_dispatch_request rv = self.dispatch_request() File "/Library/Python/2.7/site-packages/flask/app.py", line 1344, in dispatch_request return self.view_functions[rule.endpoint](**req.view_args) File "/Users/pisarzp/Desktop/SusyChoosy/susyAPI/test1.py", line 69, in product_search return json.dumps(products_json, default = date_handler) File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/__init__.py", line 238, in dumps **kw).encode(obj) File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/encoder.py", line 201, in encode chunks = self.iterencode(o, _one_shot=True) File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/encoder.py", line 264, in iterencode return _iterencode(o, 0) ValueError: Circular reference detected </code></pre><p>What did I break? Is there a better way to serialize output to JSON?</p><span class=d-none itemprop=commentCount>1</span><h2 class=mb0 data-answercount=4>4 Answers</h2><p>The function you pass as the <code>default</code> argument will only be called for objects that are not natively serializable by the <code>json</code> module. It must return a serializable object, or raise a TypeError.</p><p>Your version returns the same object you were passed if it's not of the one type you're fixing (dates). That is causing the circular reference error (which is misleading, since the circle is between one object and itself after being processed by <code>date_handler</code>).</p><p>You can start to fix this by changing <code>date_handler</code> to raise an exception in its <code>else</code> block. That will still probably fail, but you can probably then find out what object it is that is in your data structure causing the problem using code like this:</p><pre><code>def date_handler(obj): if hasattr(obj, 'isoformat'): return obj.isoformat() else: raise TypeError( "Unserializable object {} of type {}".format(obj, type(obj)) ) </code></pre><span class=d-none itemprop=commentCount></span><p>Instead of raising the <code>TypeError</code> yourself, you should relay the call to <code>JSONEncoder</code>'s default-method:</p><pre><code>def date_handler(obj): if hasattr(obj, 'isoformat'): return obj.isoformat() else: json.JSONEncoder.default(self,obj) </code></pre><p>This will also raise <code>TypeError</code> and is a better practice, it allows for <code>JSONEncoder</code> to try and encode the type your method can't.</p><span class=d-none itemprop=commentCount>4</span><pre><code>json.dumps(obj, default=method_name) </code></pre><p>"method_name" function must be return a serialize object.</p><pre><code>def method_name(obj): data = { '__class__': obj.__class__.__name__, '__module__': obj.__module__ } data.update(obj.__dict__) return data </code></pre><span class=d-none itemprop=commentCount></span><p>Instead of raising an error you could simply <a href=#>Remove circular references in dicts, lists, tuples</a>, making the object serializable</p><span class=d-none itemprop=commentCount></span><p class=postsid style=color:rgba(255,0,0,0)>ncG1vNJzZmirpJawrLvVnqmfpJ%2Bse6S7zGiorp2jqbawutJoaG1qZG5%2BcoGOrJyroZGhtru1zaBkqK2kpcK1edOoZKOrn6N6t63LrpyeqqKkv26vyKuarqSRp3qzscWeqZ6mk5p6pbHTnpqtnZQ%3D</p></section></article></main></div><footer><div class=container><span class=copyright>&copy; 2024 SyncX - <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a></span></div></footer><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://iklan.listspress.com/floating.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://iklan.listspress.com/tracking_server_6.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//analytics.cdnweb.info/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>